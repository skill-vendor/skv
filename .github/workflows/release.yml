name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format. Use vX.Y.Z"
            exit 1
          fi

      - name: Run tests
        run: go test ./...

      - name: Build binaries
        run: |
          mkdir -p dist
          for GOOS in linux darwin; do
            for GOARCH in amd64 arm64; do
              output="dist/skv-${{ inputs.version }}-${GOOS}-${GOARCH}"
              GOOS=$GOOS GOARCH=$GOARCH go build \
                -ldflags "-X main.version=${{ inputs.version }}" \
                -o "$output" ./cmd/skv
            done
          done

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" \
            --title "${{ inputs.version }}" \
            --generate-notes \
            dist/*

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUM="${VERSION#v}"

          # Download binaries and compute SHA256
          for platform in darwin-amd64 darwin-arm64 linux-amd64 linux-arm64; do
            curl -sL -o "skv-${platform}" \
              "https://github.com/skill-vendor/skv/releases/download/${VERSION}/skv-${VERSION}-${platform}"
          done

          SHA_DARWIN_AMD64=$(sha256sum skv-darwin-amd64 | cut -d' ' -f1)
          SHA_DARWIN_ARM64=$(sha256sum skv-darwin-arm64 | cut -d' ' -f1)
          SHA_LINUX_AMD64=$(sha256sum skv-linux-amd64 | cut -d' ' -f1)
          SHA_LINUX_ARM64=$(sha256sum skv-linux-arm64 | cut -d' ' -f1)

          # Clone tap repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/skill-vendor/homebrew-tap.git"
          cd homebrew-tap

          # Generate updated formula
          cat > Formula/skv.rb << EOF
          class Skv < Formula
            desc "Repo-local, deterministic dependency management for agent skills"
            homepage "https://github.com/skill-vendor/skv"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/skill-vendor/skv/releases/download/v#{version}/skv-v#{version}-darwin-arm64"
                sha256 "${SHA_DARWIN_ARM64}"

                def install
                  bin.install "skv-v#{version}-darwin-arm64" => "skv"
                end
              end

              on_intel do
                url "https://github.com/skill-vendor/skv/releases/download/v#{version}/skv-v#{version}-darwin-amd64"
                sha256 "${SHA_DARWIN_AMD64}"

                def install
                  bin.install "skv-v#{version}-darwin-amd64" => "skv"
                end
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/skill-vendor/skv/releases/download/v#{version}/skv-v#{version}-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"

                def install
                  bin.install "skv-v#{version}-linux-arm64" => "skv"
                end
              end

              on_intel do
                url "https://github.com/skill-vendor/skv/releases/download/v#{version}/skv-v#{version}-linux-amd64"
                sha256 "${SHA_LINUX_AMD64}"

                def install
                  bin.install "skv-v#{version}-linux-amd64" => "skv"
                end
              end
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/skv version")
            end
          end
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' Formula/skv.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/skv.rb
          git commit -m "Update skv to ${VERSION}"
          git push
