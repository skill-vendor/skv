# Happy path: init -> add -> sync

env GIT_AUTHOR_NAME=TestUser
env GIT_AUTHOR_EMAIL=test@example.com
env GIT_COMMITTER_NAME=TestUser
env GIT_COMMITTER_EMAIL=test@example.com
env GIT_AUTHOR_DATE=2000-01-01T00:00:00Z
env GIT_COMMITTER_DATE=2000-01-01T00:00:00Z

exec mkdir workspace
exec sh -c 'cd workspace && skv init'

# Create a local repo with a nested skill.
exec mkdir -p workspace/skillrepo/skills/skill-foo
exec git -C workspace/skillrepo -c init.defaultBranch=main init
exec sh -c 'printf "%s\n" "---" "name: skill-foo" "description: demo skill" "---" > workspace/skillrepo/skills/skill-foo/SKILL.md'
exec sh -c 'printf "%s\n" "MIT License" "" "Copyright (c) 2000 Example" > workspace/skillrepo/LICENSE'
exec git -C workspace/skillrepo add .
exec git -C workspace/skillrepo commit -m add-skill

exec sh -c 'cd workspace && skv add file://$PWD/skillrepo:skills/skill-foo'
exec sh -c 'cd workspace && skv sync'

# Assert vendored content exists.
exists workspace/.skv/skills/skill-foo/SKILL.md

# Assert symlinks point to vendored skill.
exec sh -c 'test "$(readlink workspace/.codex/skills/skill-foo)" = "../../.skv/skills/skill-foo"'
exec sh -c 'test "$(readlink workspace/.claude/skills/skill-foo)" = "../../.skv/skills/skill-foo"'
exec sh -c 'test "$(readlink workspace/.opencode/skill/skill-foo)" = "../../.skv/skills/skill-foo"'

# Build expected lock file with deterministic checksum.
exec sh -c 'set -e; hashdir() { dir="$1"; ( cd "$dir" && find . -type f | sed "s|^./||" | LC_ALL=C sort | while IFS= read -r f; do [ -z "$f" ] && continue; h=$(shasum -a 256 "$f" | awk "{print \$1}"); printf "%s  %s\n" "$h" "$f"; done | shasum -a 256 | awk "{print \$1}" ); }; repo_url="file://$PWD/workspace/skillrepo"; commit=$(git -C workspace/skillrepo rev-parse HEAD); checksum=$(hashdir workspace/.skv/skills/skill-foo); sed -e "s|__REPO__|$repo_url|g" -e "s|__COMMIT__|$commit|g" -e "s|__CHECKSUM__|$checksum|g" expected.lock.tmpl > workspace/expected.lock'

cmp workspace/skv.lock workspace/expected.lock

-- expected.lock.tmpl --
{
  "skills": [
    {
      "name": "skill-foo",
      "repo": "__REPO__",
      "path": "skills/skill-foo",
      "commit": "__COMMIT__",
      "checksum": "__CHECKSUM__",
      "license": {
        "spdx": "MIT",
        "path": "LICENSE"
      }
    }
  ]
}
