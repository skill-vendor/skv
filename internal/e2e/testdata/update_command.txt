# Update should move a floating ref and rewrite lock + vendored content.

env GIT_AUTHOR_NAME=TestUser
env GIT_AUTHOR_EMAIL=test@example.com
env GIT_COMMITTER_NAME=TestUser
env GIT_COMMITTER_EMAIL=test@example.com
env GIT_AUTHOR_DATE=2000-01-01T00:00:00Z
env GIT_COMMITTER_DATE=2000-01-01T00:00:00Z

exec mkdir workspace
exec sh -c 'cd workspace && skv init'

exec mkdir -p workspace/skillrepo/skill-foo
exec git -C workspace/skillrepo -c init.defaultBranch=main init
exec sh -c 'printf "%s\n" "---" "name: skill-foo" "description: demo skill" "---" > workspace/skillrepo/skill-foo/SKILL.md'
exec sh -c 'printf "%s\n" "v1" > workspace/skillrepo/skill-foo/version.txt'
exec git -C workspace/skillrepo add .
exec git -C workspace/skillrepo commit -m add-skill

exec sh -c 'cd workspace && printf "skv: {\n  skills: [\n    {\n      name: \\\"skill-foo\\\"\n      repo: \\\"file://$PWD/skillrepo\\\"\n      path: \\\"skill-foo\\\"\n      ref: \\\"main\\\"\n    },\n  ]\n}\n" > skv.cue'

exec sh -c 'cd workspace && skv sync'

# Advance the repo.
exec sh -c 'printf "%s\n" "v2" > workspace/skillrepo/skill-foo/version.txt'
exec git -C workspace/skillrepo add .
exec git -C workspace/skillrepo commit -m update-skill

# Expected: update refreshes vendored content + lock.
exec sh -c 'cd workspace && skv update skill-foo'

# Expected lock file.
exec sh -c 'set -e; hashdir() { dir="$1"; ( cd "$dir" && find . -type f | sed "s|^./||" | LC_ALL=C sort | while IFS= read -r f; do [ -z "$f" ] && continue; h=$(shasum -a 256 "$f" | awk "{print \$1}"); printf "%s  %s\n" "$h" "$f"; done | shasum -a 256 | awk "{print \$1}" ); }; repo_url="file://$PWD/workspace/skillrepo"; commit=$(git -C workspace/skillrepo rev-parse HEAD); checksum=$(hashdir workspace/.skv/skills/skill-foo); sed -e "s|__REPO__|$repo_url|g" -e "s|__COMMIT__|$commit|g" -e "s|__CHECKSUM__|$checksum|g" expected.lock.tmpl > workspace/expected.lock'

cmp workspace/skv.lock workspace/expected.lock

-- expected.lock.tmpl --
{
  "skills": [
    {
      "name": "skill-foo",
      "repo": "__REPO__",
      "path": "skill-foo",
      "ref": "main",
      "commit": "__COMMIT__",
      "checksum": "__CHECKSUM__"
    }
  ]
}
