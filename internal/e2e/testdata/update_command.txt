# Update should move a floating ref and rewrite lock + vendored content.

mkdir workspace
cd workspace
exec skv init
render skv.cue.tmpl skv.cue repo=skillrepo

exec git -C skillrepo -c init.defaultBranch=main init
exec git -C skillrepo add .
exec git -C skillrepo commit -m add-skill

exec skv sync

# Advance the repo.
cp version.v2.txt skillrepo/skill-foo/version.txt
exec git -C skillrepo add skill-foo/version.txt
exec git -C skillrepo commit -m update-skill

# Expected: update refreshes vendored content + lock.
exec skv update skill-foo

lockcmp skv.lock expected.lock.tmpl repo=skillrepo checksum=.skv/skills/skill-foo

-- workspace/skillrepo/skill-foo/SKILL.md --
---
name: skill-foo
description: demo skill
---
-- workspace/skillrepo/skill-foo/version.txt --
v1
-- workspace/version.v2.txt --
v2
-- workspace/skv.cue.tmpl --
skv: {
  skills: [
    {
      name: "skill-foo"
      repo: "__REPO__"
      path: "skill-foo"
      ref: "main"
    },
  ]
}
-- workspace/expected.lock.tmpl --
{
  "skills": [
    {
      "name": "skill-foo",
      "repo": "__REPO__",
      "path": "skill-foo",
      "ref": "main",
      "commit": "__COMMIT__",
      "checksum": "__CHECKSUM__"
    }
  ]
}
